<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Users — Success Pay Investments (Admin)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    :root{
      --navy-900:#0b1220; --navy-800:#111827;
      --ink:#0b1324; --muted:#64748b; --card:#ffffff; --border:#e5e7eb;
      --accent:#f59e0b; --accent2:#d97706;
      --shadow:0 16px 40px rgba(2,6,23,.10);
      --danger:#9f1239; --danger-bg:#fff1f2; --danger-br:#fecdd3;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(160deg,var(--navy-900) 0%, #101a2f 60%, var(--navy-800) 100%);
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Noto Sans",sans-serif;
      color:var(--ink);
    }
    header{
      padding:16px; color:#f8fafc;
      background:linear-gradient(135deg, rgba(245,158,11,.18), transparent 40%);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; gap:12px; align-items:center}
    .brand i{
      width:44px; height:44px; border-radius:12px; display:flex; align-items:center; justify-content:center;
      background:rgba(245,158,11,.14); color:#f59e0b; border:1px solid rgba(245,158,11,.22);
    }
    .brand h1{margin:0; font-size:18px; font-weight:800}
    .nav-links a{
      display:inline-flex; align-items:center; gap:8px; text-decoration:none;
      padding:10px 12px; border-radius:12px; font-weight:800; color:#111827;
      background:linear-gradient(180deg,var(--accent) 0%, var(--accent2) 100%); box-shadow:0 10px 24px rgba(217,119,6,.28);
      margin-left:8px;
    }

    .sheet{background:#fff; border-radius:18px 18px 0 0; margin-top:8px; padding:16px}
    .tools{display:flex; gap:10px; align-items:center; margin-bottom:12px}
    .tools input{
      flex:1; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#f8fafc; font-size:14px;
    }
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    @media (max-width:1000px){.grid{grid-template-columns:1fr}}

    .card{
      border:1px solid var(--border); background:#fff; border-radius:16px; box-shadow:var(--shadow); padding:14px;
    }
    .title{font-weight:800; font-size:16px; margin-bottom:6px}
    .muted{color:var(--muted); font-size:12px}
    .mono{font-feature-settings:"tnum" 1,"lnum" 1}

    .kv{display:grid; grid-template-columns:160px 1fr; gap:6px 12px; margin:10px 0}
    @media (max-width:600px){.kv{grid-template-columns:1fr}}
    .k{color:#475569; font-size:12px}
    .v{font-size:14px; word-break:break-word}

    .row{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin:8px 0}
    @media (max-width:760px){.row{grid-template-columns:1fr}}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:4px}
    input{
      width:100%; padding:12px; border:1px solid var(--border); border-radius:12px; background:#f8fafc; font-size:14px;
    }
    input:focus{outline:none; border-color:#c7d2fe; box-shadow:0 0 0 4px rgba(79,70,229,.12); background:#fff}

    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .btn{
      padding:10px 12px; border:none; border-radius:12px; font-weight:800; cursor:pointer; display:inline-flex; align-items:center; gap:8px;
    }
    .save{background:linear-gradient(180deg,var(--accent) 0%, var(--accent2) 100%); color:#111827; box-shadow:0 10px 24px rgba(217,119,6,.28)}
    .danger{background:var(--danger-bg); color:var(--danger); border:1px solid var(--danger-br)}
    .neutral{background:#f3f4f6; border:1px solid var(--border)}

    .inv-list{display:grid; gap:8px; margin-top:10px}
    .inv{
      border:1px solid var(--border); border-radius:12px; padding:10px; display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center;
    }
    .chip{
      background:#f9fafb; border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; margin-right:6px;
      display:inline-block;
    }

    .skeleton{background:linear-gradient(90deg,#f3f4f6 25%,#eceef2 37%,#f3f4f6 63%); background-size:400% 100%; animation:sh 1.2s infinite}
    @keyframes sh{0%{background-position:100% 0}100%{background-position:0 0}}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <i class="fas fa-users-cog"></i>
      <div>
        <h1>Users (Admin)</h1>
        <div class="muted">Success Pay Investments</div>
      </div>
    </div>
    <div class="nav-links">
      <a href="admin-index.html"><i class="fas fa-arrow-left"></i> Admin</a>
      <a href="analysis.html"><i class="fas fa-chart-bar"></i> Analysis</a>
    </div>
  </header>

  <div class="sheet">
    <div class="tools">
      <input id="q" placeholder="Filter by name, email, nickname, phone…" oninput="filterNow()"/>
    </div>

    <div id="cards" class="grid">
      <div class="card skeleton" style="height:120px;border-radius:16px"></div>
      <div class="card skeleton" style="height:120px;border-radius:16px"></div>
    </div>
  </div>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDocs, getDoc, query, where,
      updateDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // SAME FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyDqXsmhAt_jDRC3sYzSZ0mJXGLHoQYlPBc",
      authDomain: "sonicearn-a13b3.firebaseapp.com",
      projectId: "sonicearn-a13b3",
      storageBucket: "sonicearn-a13b3.firebasestorage.app",
      messagingSenderId: "538538743721",
      appId: "1:538538743721:web:3ca577a8b2a6ba43e416b8",
      measurementId: "G-XGD292PMYM"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const byId = (id)=>document.getElementById(id);
    const fmt = (n)=>new Intl.NumberFormat('en-UG',{maximumFractionDigits:0}).format(Math.round(n||0));

    let USERS = []; // in-memory list of users + fields

    // RENDER

    function kvDump(user){
      // Dump every field as key/value, converting timestamps if present
      const rows = Object.entries(user).map(([k,v])=>{
        let val = v;
        if(val && typeof val === 'object' && typeof val.toDate === 'function'){
          val = val.toDate().toString();
        }
        return `<div class="k">${k}</div><div class="v">${(typeof val==='number')?('UGX '+fmt(val)):String(val)}</div>`;
      }).join('');
      return `<div class="kv">${rows}</div>`;
    }

    async function loadInvestmentsHTML(userId){
      const invQ = query(collection(db,'investments'), where('userId','==', userId));
      const invSnap = await getDocs(invQ);
      if(invSnap.empty) return '<div class="muted">No investments.</div>';

      const nodes = [];
      invSnap.forEach(d=>{
        const x = d.data();
        nodes.push(`
          <div class="inv" data-inv="${d.id}">
            <div>
              <span class="chip mono">Amount: UGX ${fmt(x.amount||0)}</span>
              <span class="chip">Status: ${x.status||'active'}</span>
              <span class="chip mono">Daily: UGX ${fmt(x.dailyEarning||0)}</span>
              <span class="chip mono">Remaining: ${x.remainingDays??0} days</span>
              <span class="chip mono">Total Earned: UGX ${fmt(x.totalEarned||0)}</span>
            </div>
            <button class="btn danger" data-del-inv="${d.id}" data-uid="${userId}">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        `);
      });
      return `<div class="inv-list">${nodes.join('')}</div>`;
    }

    async function userCardHTML(u){
      const uid = u.id;
      const invHTML = await loadInvestmentsHTML(uid);

      // Editable inputs for 3 numeric fields (pre-fill defaults even if undefined)
      const accountBalance = Number(u.accountBalance || 0);
      const totalWithdrawn = Number(u.totalWithdrawn || 0);
      const totalDeposits  = Number(u.totalDeposits  || 0);

      return `
        <div class="card" id="card_${uid}">
          <div class="title">${u.name || '(no name)'} ${u.nickname ? '• @'+u.nickname : ''}</div>
          <div class="muted mono" style="margin-bottom:6px">${uid}</div>

          <div class="row">
            <div>
              <label>Account Balance (UGX)</label>
              <input type="number" inputmode="numeric" id="bal_${uid}" value="${accountBalance}">
            </div>
            <div>
              <label>Total Withdrawn (UGX)</label>
              <input type="number" inputmode="numeric" id="wd_${uid}" value="${totalWithdrawn}">
            </div>
            <div>
              <label>Total Deposits (UGX)</label>
              <input type="number" inputmode="numeric" id="dep_${uid}" value="${totalDeposits}">
            </div>
          </div>

          <div class="actions">
            <button class="btn save" data-save="${uid}"><i class="fas fa-save"></i> Save Changes</button>
            <button class="btn danger" data-del-user="${uid}"><i class="fas fa-user-slash"></i> Delete Account</button>
            <button class="btn neutral" data-refresh="${uid}"><i class="fas fa-rotate"></i> Refresh Investments</button>
          </div>

          <hr style="border:none;border-top:1px solid #f1f5f9; margin:12px 0"/>

          <div class="title" style="font-size:14px;">Investments</div>
          ${invHTML}

          <hr style="border:none;border-top:1px solid #f1f5f9; margin:12px 0"/>

          <div class="title" style="font-size:14px;">User Document (all fields)</div>
          ${kvDump(u)}
        </div>
      `;
    }

    async function renderUsers(list){
      const cards = byId('cards');
      if(list.length===0){
        cards.innerHTML = '<div class="card"><div class="muted">No users found.</div></div>';
        return;
      }
      // build sequentially to avoid blank page while awaiting investments per user
      cards.innerHTML = '';
      for(const u of list){
        const html = await userCardHTML(u);
        const holder = document.createElement('div');
        holder.innerHTML = html;
        cards.appendChild(holder.firstElementChild);
      }
    }

    // LOAD USERS
    async function loadUsers(){
      const snap = await getDocs(collection(db,'users'));
      USERS = [];
      snap.forEach(d => USERS.push({ id:d.id, ...d.data() }));
      // sort by name/nickname for consistency
      USERS.sort((a,b)=> (a.name||a.nickname||'').localeCompare(b.name||b.nickname||''));
      await renderUsers(USERS);
    }

    // FILTER
    window.filterNow = async function(){
      const q = byId('q').value.toLowerCase();
      const filtered = USERS.filter(u=>{
        const hay = `${u.name||''} ${u.email||''} ${u.nickname||''} ${u.phone||''}`;
        return hay.toLowerCase().includes(q);
      });
      await renderUsers(filtered);
    }

    // ACTIONS (Save, Delete Investment, Delete User, Refresh Investments)
    document.addEventListener('click', async (e)=>{
      const save = e.target.closest('[data-save]');
      const delInv = e.target.closest('[data-del-inv]');
      const delUser = e.target.closest('[data-del-user]');
      const refresh = e.target.closest('[data-refresh]');

      if(save){
        const uid = save.dataset.save;
        const bal = Number(byId(`bal_${uid}`).value || 0);
        const wd  = Number(byId(`wd_${uid}`).value  || 0);
        const dep = Number(byId(`dep_${uid}`).value || 0);
        try{
          await updateDoc(doc(db,'users', uid), {
            accountBalance: bal,
            totalWithdrawn: wd,
            totalDeposits: dep
          });
          alert('Saved changes.');
        }catch(err){ alert('Save error: '+err.message); }
      }

      if(delInv){
        const invId = delInv.dataset.delInv;
        const uid = delInv.dataset.uid;
        if(!confirm('Delete this investment?')) return;
        try{
          await deleteDoc(doc(db,'investments', invId));
          // refresh just the one card
          await refreshCard(uid);
        }catch(err){ alert('Delete error: '+err.message); }
      }

      if(delUser){
        const uid = delUser.dataset.delUser;
        if(!confirm('Delete this user account and ALL their investments?')) return;
        try{
          // delete all investments for this user
          const invQ = query(collection(db,'investments'), where('userId','==', uid));
          const invSnap = await getDocs(invQ);
          const tasks = [];
          invSnap.forEach(d => tasks.push(deleteDoc(doc(db,'investments', d.id))));
          await Promise.all(tasks);
          // delete user doc
          await deleteDoc(doc(db,'users', uid));
          alert('User and investments deleted.');
          await loadUsers();
        }catch(err){ alert('Delete error: '+err.message); }
      }

      if(refresh){
        const uid = refresh.dataset.refresh;
        await refreshCard(uid);
      }
    });

    async function refreshCard(uid){
      // re-fetch this user + re-render its single card in place
      const snap = await getDoc(doc(db,'users', uid));
      if(!snap.exists()) { await loadUsers(); return; }
      const u = { id:snap.id, ...snap.data() };
      const holder = byId(`card_${uid}`);
      if(holder){
        holder.outerHTML = await userCardHTML(u);
      }else{
        await loadUsers();
      }
    }

    // AUTH (simple gate; add isAdmin check if you maintain one)
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href='login.html'; return; }
      await loadUsers();
    });
  </script>
</body>
</html>