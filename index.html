<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Admin — Success Pay Investments</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    :root{
      --navy-900:#0b1220; --navy-800:#111827;
      --ink:#0b1324; --muted:#64748b; --card:#ffffff; --border:#e5e7eb;
      --accent:#f59e0b; --accent2:#d97706;
      --shadow:0 16px 40px rgba(2,6,23,.10);
      --success:#065f46; --success-bg:#ecfdf5; --success-br:#a7f3d0;
      --danger:#9f1239; --danger-bg:#fff1f2; --danger-br:#fecdd3;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(160deg,var(--navy-900) 0%, #101a2f 60%, var(--navy-800) 100%);
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Noto Sans",sans-serif;
      color:var(--ink);
    }

    /* Header */
    header{
      padding:16px; color:#f8fafc;
      background:linear-gradient(135deg, rgba(245,158,11,.18), transparent 40%);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .brand i{
      width:44px; height:44px; border-radius:12px; display:flex; align-items:center; justify-content:center;
      background:rgba(245,158,11,.14); color:#f59e0b; border:1px solid rgba(245,158,11,.22);
    }
    .brand h1{margin:0; font-size:18px; font-weight:800}
    .top-links{display:flex; gap:10px}
    .link-btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:12px; text-decoration:none; font-weight:800; color:#111827;
      background:linear-gradient(180deg,var(--accent) 0%, var(--accent2) 100%); box-shadow:0 10px 24px rgba(217,119,6,.28);
    }

    /* Content sheet */
    .sheet{background:#fff; border-radius:18px 18px 0 0; margin-top:8px; padding:18px 16px 26px}

    /* Totals (4 cards) */
    .totals{display:grid; grid-template-columns:repeat(4,1fr); gap:12px}
    @media (max-width:1100px){.totals{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.totals{grid-template-columns:1fr}}
    .sum-card{
      border:1px solid var(--border); background:var(--card); border-radius:16px; box-shadow:var(--shadow);
      padding:14px;
    }
    .label{font-size:12px; color:var(--muted); margin-bottom:6px}
    .value{font-size:18px; font-weight:800}
    .mono{font-feature-settings:"tnum" 1,"lnum" 1}

    /* Columns for pending lists */
    .cols{display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:18px}
    @media (max-width:980px){.cols{grid-template-columns:1fr}}

    /* Panel container */
    .panel{border:1px solid var(--border); background:#fff; border-radius:16px; box-shadow:var(--shadow); overflow:hidden}
    .panel header{all:unset; display:flex; align-items:center; justify-content:space-between; padding:12px 14px; background:#f9fafb; border-bottom:1px solid #f1f5f9}
    .panel h2{font-size:15px; margin:0; font-weight:800}
    .hint{color:var(--muted); font-size:12px}

    /* Card list (not tables) */
    .list{display:grid; gap:12px; padding:12px 12px 16px}
    .card-item{
      border:1px solid var(--border); background:var(--card); border-radius:14px; padding:12px;
      display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center;
    }
    .c-title{font-weight:800}
    .c-sub{color:var(--muted); font-size:12px}
    .row{display:flex; flex-wrap:wrap; gap:10px; margin-top:6px}
    .chip{
      background:#f9fafb; border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px;
    }
    .badge{
      padding:6px 10px; border-radius:999px; font-size:12px; font-weight:800;
      background:#fff7ed; color:#92400e; border:1px solid #fde68a; display:inline-block;
    }
    .actions{display:flex; gap:8px}
    .btn{
      padding:8px 10px; border:none; border-radius:10px; font-weight:800; cursor:pointer;
      display:inline-flex; align-items:center; gap:6px;
    }
    .approve{background:var(--success-bg); color:var(--success); border:1px solid var(--success-br)}
    .reject{background:var(--danger-bg); color:var(--danger); border:1px solid var(--danger-br)}

    /* Skeleton */
    .skeleton{background:linear-gradient(90deg,#f3f4f6 25%,#eceef2 37%,#f3f4f6 63%); background-size:400% 100%; animation:sh 1.2s infinite}
    @keyframes sh{0%{background-position:100% 0}100%{background-position:0 0}}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <i class="fas fa-shield"></i>
      <div>
        <h1>Admin Dashboard</h1>
        <div class="hint">Success Pay Investments</div>
      </div>
    </div>
    <div class="top-links">
      <a class="link-btn" href="users.html"><i class="fas fa-users"></i> Users</a>
      <a class="link-btn" href="analysis.html"><i class="fas fa-chart-bar"></i> Analysis</a>
    </div>
  </header>

  <div class="sheet">
    <!-- TOTALS -->
    <section class="totals">
      <div class="sum-card">
        <div class="label">Total Deposits (approved)</div>
        <div id="totDeposits" class="value mono skeleton" style="height:26px;border-radius:6px;"></div>
      </div>
      <div class="sum-card">
        <div class="label">Total Withdrawn (approved)</div>
        <div id="totWithdrawn" class="value mono skeleton" style="height:26px;border-radius:6px;"></div>
      </div>
      <div class="sum-card">
        <div class="label">Company Profit (Deposits − Withdrawn)</div>
        <div id="profit" class="value mono skeleton" style="height:26px;border-radius:6px;"></div>
      </div>
      <div class="sum-card">
        <div class="label">Profit Ratio (Deposits ÷ Withdrawn)</div>
        <div id="profitRatio" class="value mono skeleton" style="height:26px;border-radius:6px;"></div>
      </div>
    </section>

    <!-- PENDING LISTS (cards) -->
    <section class="cols">
      <!-- Deposits -->
      <div class="panel">
        <header>
          <h2>Pending Deposits</h2>
          <div class="hint">Approve → create investment (30 days, 15%/day) & award referrer 15%</div>
        </header>
        <div id="depList" class="list">
          <div class="card-item skeleton" style="height:56px;border-radius:12px"></div>
          <div class="card-item skeleton" style="height:56px;border-radius:12px"></div>
        </div>
      </div>

      <!-- Withdrawals -->
      <div class="panel">
        <header>
          <h2>Pending Withdrawals</h2>
          <div class="hint">Net shown = Amount − 10% fee</div>
        </header>
        <div id="wdList" class="list">
          <div class="card-item skeleton" style="height:56px;border-radius:12px"></div>
          <div class="card-item skeleton" style="height:56px;border-radius:12px"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, addDoc, updateDoc,
      query, where, serverTimestamp, increment
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase config (same project)
    const firebaseConfig = {
      apiKey: "AIzaSyDqXsmhAt_jDRC3sYzSZ0mJXGLHoQYlPBc",
      authDomain: "sonicearn-a13b3.firebaseapp.com",
      projectId: "sonicearn-a13b3",
      storageBucket: "sonicearn-a13b3.firebasestorage.app",
      messagingSenderId: "538538743721",
      appId: "1:538538743721:web:3ca577a8b2a6ba43e416b8",
      measurementId: "G-XGD292PMYM"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Constants
    const DAILY_RATE = 0.15;
    const INVEST_DAYS = 30;

    // Helpers
    const fmt = (n) => new Intl.NumberFormat('en-UG', { maximumFractionDigits: 0 }).format(Math.round(n||0));
    const fmtRatio = (n) => isFinite(n) ? (Math.round(n*100)/100).toString() : '∞';
    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

    // User cache
    const userCache = new Map();
    async function getUser(userId){
      if(userCache.has(userId)) return userCache.get(userId);
      const snap = await getDoc(doc(db,'users',userId));
      const data = snap.exists() ? snap.data() : null;
      userCache.set(userId,data);
      return data;
    }
    async function findUserByNicknameLower(nickLower){
      if(!nickLower) return null;
      const q = query(collection(db,'users'), where('nicknameLower','==', String(nickLower).toLowerCase()));
      const snap = await getDocs(q);
      if(snap.empty) return null;
      let res=null; snap.forEach(d => res={ id:d.id, ...d.data() });
      return res;
    }

    // Totals & derived KPIs
    async function loadTotals(){
      let depSum=0, wdSum=0;

      const depSnap = await getDocs(query(collection(db,'deposits'), where('status','==','approved')));
      depSnap.forEach(d => depSum += Number(d.data().amount || 0));

      const wdSnap = await getDocs(query(collection(db,'withdrawals'), where('status','==','approved')));
      wdSnap.forEach(d => wdSum += Number(d.data().amount || 0));

      const profit = depSum - wdSum;
      const ratio = wdSum === 0 ? Infinity : depSum / wdSum;

      const setText = (id, txt) => { const el=document.getElementById(id); el.classList.remove('skeleton'); el.textContent = txt; };
      setText('totDeposits', `UGX ${fmt(depSum)}`);
      setText('totWithdrawn', `UGX ${fmt(wdSum)}`);
      setText('profit', `UGX ${fmt(profit)}`);
      setText('profitRatio', fmtRatio(ratio));
    }

    // Pending Deposits (cards)
    async function loadPendingDeposits(){
      const wrap = document.getElementById('depList');
      wrap.innerHTML = '<div class="card-item skeleton" style="height:56px;border-radius:12px"></div>';

      const snap = await getDocs(query(collection(db,'deposits'), where('status','==','pending')));
      const items=[];
      for(const d of snap.docs){
        const x = d.data(); const u = await getUser(x.userId);
        items.push({
          id:d.id, userId:x.userId,
          userName: u?.name || '(no name)',
          amount:Number(x.amount||0),
          toName:x.paymentToName||'', toPhone:x.paymentToPhone||'',
          senderPhone:x.senderPhone||'',
          referrerNickname: u?.referrerNickname || null,
          status:x.status||'pending'
        });
      }
      shuffle(items);

      if(items.length===0){ wrap.innerHTML = '<div class="hint" style="padding:10px 2px">No pending deposits.</div>'; return; }

      wrap.innerHTML = items.map(x=>`
        <div class="card-item" data-id="${x.id}">
          <div>
            <div class="c-title">${x.userName}</div>
            <div class="row">
              <span class="chip mono">Amount: UGX ${fmt(x.amount)}</span>
              <span class="chip">Sent to: ${x.toName} • ${x.toPhone}</span>
              <span class="chip mono">Sender: ${x.senderPhone}</span>
              <span class="chip">Referrer: ${x.referrerNickname ? x.referrerNickname : '—'}</span>
            </div>
          </div>
          <div style="display:flex; flex-direction:column; gap:8px; align-items:end">
            <span class="badge">${x.status.toUpperCase()}</span>
            <div class="actions">
              <button class="btn approve" data-act="approve-dep" data-id="${x.id}"><i class="fas fa-check"></i>Approve</button>
              <button class="btn reject" data-act="reject-dep" data-id="${x.id}"><i class="fas fa-times"></i>Reject</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Pending Withdrawals (cards)
    async function loadPendingWithdrawals(){
      const wrap = document.getElementById('wdList');
      wrap.innerHTML = '<div class="card-item skeleton" style="height:56px;border-radius:12px"></div>';

      const snap = await getDocs(query(collection(db,'withdrawals'), where('status','==','pending')));
      const items=[];
      for(const d of snap.docs){
        const x=d.data(); const u=await getUser(x.userId);
        const amt = Number(x.amount||0), net = Math.max(0, amt*0.9);
        items.push({
          id:d.id, userId:x.userId, userName:u?.name || '(no name)',
          amount:amt, net:net, status:x.status||'pending'
        });
      }
      shuffle(items);

      if(items.length===0){ wrap.innerHTML = '<div class="hint" style="padding:10px 2px">No pending withdrawals.</div>'; return; }

      wrap.innerHTML = items.map(x=>`
        <div class="card-item" data-id="${x.id}">
          <div>
            <div class="c-title">${x.userName}</div>
            <div class="row">
              <span class="chip mono">Amount: UGX ${fmt(x.amount)}</span>
              <span class="chip mono">Net (−10%): UGX ${fmt(x.net)}</span>
            </div>
          </div>
          <div style="display:flex; flex-direction:column; gap:8px; align-items:end">
            <span class="badge">${x.status.toUpperCase()}</span>
            <div class="actions">
              <button class="btn approve" data-act="approve-wd" data-id="${x.id}"><i class="fas fa-check"></i>Approve</button>
              <button class="btn reject" data-act="reject-wd" data-id="${x.id}"><i class="fas fa-times"></i>Reject</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Actions
    async function approveDeposit(depId){
      const depRef = doc(db,'deposits',depId);
      const depSnap = await getDoc(depRef);
      if(!depSnap.exists()){ alert("Deposit not found."); return; }
      const dep = depSnap.data();
      if(dep.status !== 'pending'){ alert("Already processed."); return; }

      const user = await getUser(dep.userId);
      const userName = user?.name || '(no name)';
      const amount = Number(dep.amount||0);

      // 1) create investment
      await addDoc(collection(db,'investments'), {
        userId: dep.userId,
        userName,
        amount,
        dailyRate: DAILY_RATE,
        dailyEarning: Math.round(amount * DAILY_RATE),
        remainingDays: INVEST_DAYS,
        totalEarned: 0,
        status: 'active',
        createdAt: serverTimestamp()
      });

      // 2) award referrer 15% by referrerNickname -> users.nicknameLower
      const refNickLower = (user?.referrerNickname || '').toLowerCase();
      if(refNickLower){
        const refUser = await findUserByNicknameLower(refNickLower);
        if(refUser?.id){
          const bonus = Math.round(amount * 0.15);
          await updateDoc(doc(db,'users',refUser.id), {
            accountBalance: increment(bonus),
            totalEarnings: increment(bonus)
          });
        }
      }

      // 3) mark deposit approved + add to depositor totals
      await updateDoc(depRef, { status: 'approved' });
      if(user){
        await updateDoc(doc(db,'users', dep.userId), { totalDeposits: increment(amount) });
      }

      alert("Deposit approved: investment created, referrer awarded (if any).");
      await Promise.all([loadPendingDeposits(), loadTotals()]);
    }

    async function rejectDeposit(depId){
      const depRef = doc(db,'deposits',depId);
      const depSnap = await getDoc(depRef);
      if(!depSnap.exists()){ alert("Deposit not found."); return; }
      if(depSnap.data().status !== 'pending'){ alert("Already processed."); return; }
      await updateDoc(depRef, { status: 'rejected' });
      await loadPendingDeposits();
    }

    async function approveWithdrawal(wdId){
      const wdRef = doc(db,'withdrawals',wdId);
      const wdSnap = await getDoc(wdRef);
      if(!wdSnap.exists()){ alert("Withdrawal not found."); return; }
      if(wdSnap.data().status !== 'pending'){ alert("Already processed."); return; }
      await updateDoc(wdRef, { status: 'approved' });
      alert("Withdrawal approved.");
      await Promise.all([loadPendingWithdrawals(), loadTotals()]);
    }

    async function rejectWithdrawal(wdId){
      const wdRef = doc(db,'withdrawals',wdId);
      const wdSnap = await getDoc(wdRef);
      if(!wdSnap.exists()){ alert("Withdrawal not found."); return; }
      if(wdSnap.data().status !== 'pending'){ alert("Already processed."); return; }
      await updateDoc(wdRef, { status: 'rejected' });
      await loadPendingWithdrawals();
    }

    // Click handling
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-act]');
      if(!btn) return;
      const act = btn.dataset.act, id = btn.dataset.id;
      if(!id) return;
      if(act==='approve-dep') approveDeposit(id).catch(err=>alert(err.message));
      if(act==='reject-dep')  rejectDeposit(id).catch(err=>alert(err.message));
      if(act==='approve-wd')  approveWithdrawal(id).catch(err=>alert(err.message));
      if(act==='reject-wd')   rejectWithdrawal(id).catch(err=>alert(err.message));
    });

    // Auth (add your own admin flag check if needed)
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href='login.html'; return; }
      await Promise.all([
        loadTotals(),
        loadPendingDeposits(),
        loadPendingWithdrawals()
      ]);
    });
  </script>
</body>
</html>